# =============================================================================
# Grafana Alloy - Faro Web SDK Receiver
# =============================================================================
# Receives browser telemetry from Grafana Faro Web SDK and routes
# ALL telemetry through the OTel Collector for centralized sampling:
#   - Logs   → OTel Collector → (sampled) → Loki
#   - Traces → OTel Collector → (sampled) → Jaeger
#
# The Faro SDK sends a custom JSON payload (not OTLP), so we need Alloy's
# faro.receiver component to parse and split the data. Alloy converts
# Faro logs to OTLP via otelcol.receiver.loki before forwarding.
# =============================================================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: retail-observe
data:
  config.alloy: |
    // ── Faro receiver: accepts browser telemetry on /collect ──
    faro.receiver "default" {
      extra_log_labels = {
        app    = "frontend",
        source = "faro",
      }

      server {
        listen_address = "0.0.0.0"
        listen_port    = 12347

        cors_allowed_origins = ["*"]
      }

      output {
        logs   = [loki.process.faro.receiver]
        traces = [otelcol.exporter.otlphttp.default.input]
      }
    }

    // ── Extract kind label from logfmt body for Loki queries ──
    loki.process "faro" {
      stage.logfmt {
        mapping = {
          kind             = "",
          measurement_type = "type",
        }
      }

      stage.labels {
        values = {
          kind             = "kind",
          measurement_type = "measurement_type",
        }
      }

      forward_to = [otelcol.receiver.loki.default.receiver]
    }

    // ── Convert Loki-format logs to OTLP and forward to OTel Collector ──
    // otelcol.receiver.loki accepts Loki log entries from loki.process,
    // converts them to OTLP log records, and forwards to the OTLP exporter.
    // The OTel Collector then applies severity-based sampling before sending to Loki.
    otelcol.receiver.loki "default" {
      output {
        logs = [otelcol.exporter.otlphttp.default.input]
      }
    }

    // ── Forward all telemetry (logs + traces) to OTel Collector ──
    otelcol.exporter.otlphttp "default" {
      client {
        endpoint = "http://otel-collector.retail-observe.svc.cluster.local:4318"
      }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alloy
  namespace: retail-observe
  labels:
    app: alloy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alloy
  template:
    metadata:
      labels:
        app: alloy
    spec:
      containers:
        - name: alloy
          image: grafana/alloy:v1.5.1
          args:
            - run
            - /etc/alloy/config.alloy
            - --server.http.listen-addr=0.0.0.0:12345
            - --stability.level=generally-available
          ports:
            - containerPort: 12347
              name: faro
            - containerPort: 12345
              name: http
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /etc/alloy
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 12345
            initialDelaySeconds: 10
            periodSeconds: 15
          livenessProbe:
            httpGet:
              path: /-/ready
              port: 12345
            initialDelaySeconds: 15
            periodSeconds: 30
      volumes:
        - name: config
          configMap:
            name: alloy-config

---
apiVersion: v1
kind: Service
metadata:
  name: alloy
  namespace: retail-observe
  labels:
    app: alloy
spec:
  selector:
    app: alloy
  ports:
    - port: 12347
      targetPort: 12347
      name: faro
    - port: 12345
      targetPort: 12345
      name: http
