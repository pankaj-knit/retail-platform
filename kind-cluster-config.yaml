# kind (Kubernetes IN Docker) cluster configuration
# This defines a local K8s cluster with 1 control-plane and 2 worker nodes.
#
# Why 3 nodes?
# - Control plane: runs the K8s API server, scheduler, etcd, controller-manager
# - Worker 1 & 2: run our application pods (services, databases, kafka, etc.)
#   Having 2 workers lets K8s spread pods across nodes, simulating real HA setups.
#
# Port mappings expose services on your localhost so you can access them
# from your browser without needing `kubectl port-forward` every time.

kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

nodes:
  # --- Control Plane Node ---
  # Runs K8s system components (API server, etcd, scheduler).
  # In production, you'd have 3+ control planes for HA.
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraPortMappings:
      # HTTP traffic -> Istio Ingress Gateway (will be configured in Step 9)
      - containerPort: 80
        hostPort: 80
        protocol: TCP
      # HTTPS traffic -> Istio Ingress Gateway
      - containerPort: 443
        hostPort: 443
        protocol: TCP
      # Istio Ingress Gateway NodePorts
      - containerPort: 30080
        hostPort: 30080
        protocol: TCP
      - containerPort: 30443
        hostPort: 30443
        protocol: TCP
      # Observability NodePorts
      - containerPort: 30030
        hostPort: 30030
        protocol: TCP
      - containerPort: 30086
        hostPort: 30086
        protocol: TCP
      - containerPort: 30090
        hostPort: 30090
        protocol: TCP
      # NodePort range for direct service access during development
      - containerPort: 30000
        hostPort: 30000
        protocol: TCP
      - containerPort: 30001
        hostPort: 30001
        protocol: TCP
      - containerPort: 30002
        hostPort: 30002
        protocol: TCP
      - containerPort: 30003
        hostPort: 30003
        protocol: TCP
      - containerPort: 30004
        hostPort: 30004
        protocol: TCP
      - containerPort: 30005
        hostPort: 30005
        protocol: TCP

  # --- Worker Node 1 ---
  # Runs application workloads (microservices, databases)
  - role: worker

  # --- Worker Node 2 ---
  # Runs application workloads (observability stack, kafka)
  - role: worker
