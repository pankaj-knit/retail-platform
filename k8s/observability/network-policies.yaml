# =============================================================================
# NetworkPolicies for retail-observe namespace
# =============================================================================
# Observability tools need to:
#   - Receive telemetry from retail-app (metrics, traces, logs)
#   - Serve UIs to external users (Grafana, Jaeger, Prometheus)
#   - Communicate internally (Grafana → Prometheus, Promtail → Loki)
# =============================================================================

---
# OTel Collector: receives from retail-app, sends to Jaeger/Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: otel-collector-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: otel-collector
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - ports:
        - port: 4317
          protocol: TCP
        - port: 4318
          protocol: TCP
        - port: 9411
          protocol: TCP
        - port: 8889
          protocol: TCP
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: jaeger
      ports:
        - port: 4318
          protocol: TCP
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

---
# Jaeger: receives from OTel Collector + Istio sidecars, serves UI
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: jaeger-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: jaeger
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - port: 16686
          protocol: TCP
        - port: 4317
          protocol: TCP
        - port: 4318
          protocol: TCP
        - port: 9411
          protocol: TCP

---
# Prometheus: scrapes retail-app pods, serves UI + Grafana queries
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - ports:
        - port: 9090
          protocol: TCP
  egress:
    - {}

---
# Loki: receives logs from Promtail, serves queries to Grafana
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: loki-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: loki
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - port: 3100
          protocol: TCP

---
# Promtail: needs egress to Loki + K8s API server.
# The K8s API server ClusterIP (10.96.0.1) is not a pod, so
# namespaceSelector/podSelector won't match it. We use an open
# egress rule since Promtail is a trusted observability DaemonSet.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: promtail-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: promtail
  policyTypes:
    - Egress
  egress:
    - {}

---
# Grafana: needs egress to Prometheus, Jaeger, Loki, Vault, and external SMTP/webhooks
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - ports:
        - port: 3000
          protocol: TCP
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - port: 9090
          protocol: TCP
    - to:
        - podSelector:
            matchLabels:
              app: jaeger
      ports:
        - port: 16686
          protocol: TCP
    - to:
        - podSelector:
            matchLabels:
              app: loki
      ports:
        - port: 3100
          protocol: TCP
    - to:
        - namespaceSelector:
            matchLabels:
              name: retail-data
      ports:
        - port: 8200
          protocol: TCP
    # External: SMTP (email alerts) and HTTPS (Teams webhooks)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 587
          protocol: TCP
        - port: 465
          protocol: TCP
        - port: 443
          protocol: TCP
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

# ─── Grafana Alloy (Faro receiver) ───
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: alloy-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: alloy
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - ports:
        - port: 12347
          protocol: TCP
        - port: 12345
          protocol: TCP
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: loki
      ports:
        - port: 3100
          protocol: TCP
    - to:
        - podSelector:
            matchLabels:
              app: otel-collector
      ports:
        - port: 4317
          protocol: TCP
        - port: 4318
          protocol: TCP
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

# ─── Blackbox Exporter ───
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: blackbox-exporter-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: blackbox-exporter
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - port: 9115
          protocol: TCP
  egress:
    # Istio ingress gateway (HTTP probes via gateway, service:80 -> pod:8080)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
      ports:
        - port: 80
          protocol: TCP
        - port: 8080
          protocol: TCP
    # Data layer (TCP probes)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: retail-data
      ports:
        - port: 9092
          protocol: TCP
        - port: 5432
          protocol: TCP
        - port: 6379
          protocol: TCP
    # DNS
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP

# ─── Pushgateway ───
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: pushgateway-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: pushgateway
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - port: 9091
          protocol: TCP
    - from:
        - podSelector:
            matchLabels:
              app: synthetic-tests
      ports:
        - port: 9091
          protocol: TCP

# ─── Synthetic Tests CronJob ───
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synthetic-tests-netpol
  namespace: retail-observe
spec:
  podSelector:
    matchLabels:
      app: synthetic-tests
  policyTypes:
    - Egress
  egress:
    # Istio ingress gateway (tests access frontend via the gateway, service:80 -> pod:8080)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
      ports:
        - port: 80
          protocol: TCP
        - port: 8080
          protocol: TCP
    # Pushgateway (push results)
    - to:
        - podSelector:
            matchLabels:
              app: pushgateway
      ports:
        - port: 9091
          protocol: TCP
    # DNS
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
